<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homework Hero | Solo Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        /* Light/Dark Mode Variables */
        :root { 
            --app-bg: #f2f2f7; --card-bg: #ffffff; --text-main: #1c1c1e; --text-sub: #8e8e93; 
            --blue: #007aff; --green: #34c759; --red: #ff3b30; --orange: #ff9500; --border: #e5e5ea;
        }
        body.dark-mode {
            --app-bg: #000000; --card-bg: #1c1c1e; --text-main: #f8fafc; --text-sub: #94a3b8;
            --border: #334155;
        }
        
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--app-bg); color: var(--text-main); margin: 0; padding: 20px; display: flex; justify-content: center; transition: background 0.3s, color 0.3s; }
        .app-container { max-width: 450px; width: 100%; }
        .hidden { display: none !important; }
        
        /* UI Elements */
        .card { background: var(--card-bg); padding: 24px; border-radius: 20px; box-shadow: 0 4px 20px rgba(0,0,0,0.04); margin-bottom: 20px; border: 1px solid var(--border); transition: background 0.3s; }
        h1, h2, h3, h4 { margin-top: 0; font-weight: 700; }
        p { margin: 0; color: var(--text-sub); font-size: 14px; line-height: 1.4; }
        
        /* Inputs & Buttons */
        input, select { width: 100%; padding: 14px; margin: 8px 0; background: var(--app-bg); border: 1px solid var(--border); border-radius: 12px; font-size: 15px; color: var(--text-main); box-sizing: border-box; outline: none; transition: 0.2s; }
        input:focus, select:focus { border-color: var(--blue); }
        button { width: 100%; padding: 14px; border-radius: 12px; border: none; font-size: 15px; font-weight: 600; cursor: pointer; transition: 0.2s; margin-top: 5px; }
        button:active { transform: scale(0.98); }
        .btn-primary { background: var(--blue); color: white; }
        .btn-success { background: var(--green); color: white; }
        .btn-danger { background: rgba(255, 59, 48, 0.1); color: var(--red); }
        .btn-secondary { background: var(--app-bg); color: var(--text-main); border: 1px solid var(--border); }
        .btn-row { display: flex; gap: 10px; margin-top: 15px; }
        
        /* Tasks */
        .task-list { display: flex; flex-direction: column; gap: 15px; margin-bottom: 20px; }
        .task-card { background: var(--card-bg); padding: 20px; border-radius: 16px; border-left: 6px solid var(--blue); border-top: 1px solid var(--border); border-right: 1px solid var(--border); border-bottom: 1px solid var(--border); }
        .task-card.missing { border-left-color: var(--red); }
        .task-card.completed { border-left-color: var(--green); opacity: 0.7; }
        
        /* Progress, Tabs, Badges */
        .progress-track { background: var(--app-bg); height: 16px; border-radius: 8px; overflow: hidden; margin: 15px 0 5px; box-shadow: inset 0 1px 3px rgba(0,0,0,0.1); }
        .progress-fill { background: var(--blue); height: 100%; width: 0%; transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1); }
        .tab-row { display: flex; gap: 10px; margin-bottom: 15px; background: var(--app-bg); padding: 4px; border-radius: 16px; border: 1px solid var(--border); }
        .tab { flex: 1; padding: 10px; text-align: center; border-radius: 12px; font-weight: 600; color: var(--text-sub); cursor: pointer; font-size: 14px; transition: 0.2s; }
        .tab.active { background: var(--card-bg); color: var(--text-main); box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .badge { display: inline-block; font-size: 11px; padding: 4px 8px; border-radius: 20px; font-weight: 700; text-transform: uppercase; color: white; margin-left: 8px; }
        .level-badge { background: linear-gradient(135deg, #a855f7, #ec4899); color: white; padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 800; }
    </style>
</head>
<body>

<div class="app-container">
    <div id="view-auth">
        <div style="text-align: center; margin-bottom: 30px;">
            <h1 style="font-size: 32px; color: var(--blue);">Hero Pro</h1>
            <p>Your ultimate productivity engine.</p>
        </div>
        
        <div class="card">
            <div class="tab-row">
                <div id="tab-login" class="tab active" onclick="setAuthMode('login')">Log In</div>
                <div id="tab-signup" class="tab" onclick="setAuthMode('signup')">Sign Up</div>
            </div>
            <input type="text" id="auth-user" placeholder="Username" autocomplete="off">
            <input type="password" id="auth-pass" placeholder="Secure Password">
            <button id="btn-auth" class="btn-primary" onclick="processAuth()">Enter Vault</button>
            <p id="auth-error" style="color: var(--red); text-align: center; margin-top: 15px; display: none;"></p>
        </div>
    </div>

    <div id="view-main" class="hidden">
        <div class="card">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div style="display: flex; align-items: center; gap: 10px;">
                    <h2 id="header-name" style="margin: 0;">Hero</h2>
                    <span id="header-level" class="level-badge">LVL 1</span>
                </div>
                <button onclick="toggleDark()" class="btn-secondary" style="width: auto; padding: 8px 12px; margin: 0; font-size: 18px;" title="Toggle Dark Mode">üåô</button>
            </div>
            
            <div style="display: flex; justify-content: space-between; align-items: flex-end;">
                <div>
                    <p style="font-size: 12px; font-weight: bold; text-transform: uppercase; color: var(--blue);">Target Goal</p>
                    <h3 id="goal-title" style="margin: 0;">Loading...</h3>
                </div>
                <div style="text-align: right;">
                    <h2 id="stat-points" style="margin: 0; color: var(--text-main);">0 / 0</h2>
                    <p id="stat-xp" style="font-size: 11px;">0 Total XP</p>
                </div>
            </div>
            <div class="progress-track"><div id="progress-bar" class="progress-fill"></div></div>
        </div>

        <div class="card">
            <h3>+ Add Mission</h3>
            <input type="text" id="task-name" placeholder="Assignment (e.g., Essay Draft)">
            <input type="text" id="task-notes" placeholder="Notes (e.g., Min 500 words, MLA format)">
            <div style="display: flex; gap: 10px;">
                <select id="task-subject">
                    <option value="Math">Math</option><option value="Science">Science</option><option value="English">English</option><option value="History">History</option><option value="Other">Other</option>
                </select>
                <input type="date" id="task-date">
            </div>
            <button class="btn-primary" onclick="addTask()">Add to Mission Log</button>
        </div>

        <div class="card">
            <details>
                <summary style="font-weight: 600; cursor: pointer; color: var(--text-sub);">‚öôÔ∏è Edit Goal & Shop</summary>
                <input type="text" id="goal-input-name" placeholder="What are you saving for?">
                <input type="number" id="goal-input-val" placeholder="Total points needed">
                <div class="btn-row">
                    <button class="btn-primary" onclick="updateGoal()">Save Goal</button>
                    <button class="btn-secondary" onclick="spendPoints()">Spend Points</button>
                </div>
                <p style="margin-top: 10px; font-size: 12px;">"Spend Points" subtracts from your current balance when you buy a real-life reward, but keeps your lifetime XP safe!</p>
            </details>
        </div>

        <div class="tab-row" style="margin-top: 25px;">
            <div id="tab-active" class="tab active" onclick="switchView('active')">Active List</div>
            <div id="tab-completed" class="tab" onclick="switchView('completed')">Completed Log</div>
        </div>

        <div id="view-active">
            <h4 id="missing-header" style="color: var(--red); margin-bottom: 10px; display: none;">üö® Overdue</h4>
            <div id="missing-container" class="task-list"></div>
            
            <h4 id="assigned-header" style="color: var(--blue); margin-bottom: 10px; display: none;">üìÖ Upcoming</h4>
            <div id="assigned-container" class="task-list"></div>
        </div>

        <div id="view-completed" class="hidden">
            <h4 style="color: var(--green); margin-bottom: 10px;">‚úÖ Finished</h4>
            <div id="completed-container" class="task-list"></div>
        </div>
        
        <button onclick="logOut()" class="btn-secondary" style="margin-top: 20px; color: var(--red);">Log Out Securely</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD0HePOf2DBOPzp5XPjkXjxYWuhs7-WQdQ",
        authDomain: "homeworkhero-f2a15.firebaseapp.com",
        projectId: "homeworkhero-f2a15",
        storageBucket: "homeworkhero-f2a15.firebasestorage.app"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let authMode = 'login';
    let currentUsername = null;
    let currentUserUID = null;
    let vaultData = { points: 0, totalXP: 0, goalName: "Set a goal!", goalPoints: 100, tasks: [] };

    // --- DARK MODE LOGIC ---
    if(localStorage.getItem('theme') === 'dark') document.body.classList.add('dark-mode');
    window.toggleDark = () => {
        document.body.classList.toggle('dark-mode');
        localStorage.setItem('theme', document.body.classList.contains('dark-mode') ? 'dark' : 'light');
    };

    // --- UI CONTROLS ---
    window.setAuthMode = (mode) => {
        authMode = mode;
        document.getElementById('tab-login').classList.toggle('active', mode === 'login');
        document.getElementById('tab-signup').classList.toggle('active', mode === 'signup');
        document.getElementById('btn-auth').innerText = mode === 'login' ? 'Enter Vault' : 'Create Account';
        document.getElementById('auth-error').style.display = 'none';
    };

    window.switchView = (view) => {
        document.getElementById('tab-active').classList.toggle('active', view === 'active');
        document.getElementById('tab-completed').classList.toggle('active', view === 'completed');
        document.getElementById('view-active').classList.toggle('hidden', view !== 'active');
        document.getElementById('view-completed').classList.toggle('hidden', view !== 'completed');
    };

    const showError = (msg) => {
        const el = document.getElementById('auth-error');
        el.innerText = msg; el.style.display = 'block';
    };

    // --- AUTHENTICATION ---
    window.processAuth = async () => {
        const user = document.getElementById('auth-user').value.toLowerCase().trim();
        const passRaw = document.getElementById('auth-pass').value;
        if (user.length < 2 || passRaw.length < 6) return showError("Need a username and 6+ char password.");
        const email = `${user}@herosolo.com`;

        try {
            if (authMode === 'login') await signInWithEmailAndPassword(auth, email, passRaw);
            else {
                const res = await createUserWithEmailAndPassword(auth, email, passRaw);
                await setDoc(doc(db, "users", res.user.uid), { name: user });
            }
        } catch (e) {
            showError(authMode === 'login' ? "Incorrect Password or Username." : "Username taken!");
        }
    };

    onAuthStateChanged(auth, async (u) => {
        if (u) {
            currentUserUID = u.uid;
            const snap = await getDoc(doc(db, "users", u.uid));
            if(snap.exists()) {
                currentUsername = snap.data().name;
                bootApp();
            }
        } else {
            document.getElementById('view-auth').classList.remove('hidden');
            document.getElementById('view-main').classList.add('hidden');
        }
    });

    // --- APP ENGINE ---
    function bootApp() {
        document.getElementById('view-auth').classList.add('hidden');
        document.getElementById('view-main').classList.remove('hidden');
        document.getElementById('header-name').innerText = currentUsername;

        onSnapshot(doc(db, "vaults", currentUserUID), async (snap) => {
            if (!snap.exists()) {
                await setDoc(doc(db, "vaults", currentUserUID), { points: 0, totalXP: 0, goalName: "Set a goal!", goalPoints: 100, tasks: [] });
            } else {
                vaultData = snap.data();
                if(!vaultData.tasks) vaultData.tasks = [];
                if(vaultData.totalXP === undefined) vaultData.totalXP = vaultData.points || 0;
                updateDashboard();
                renderTasks();
            }
        });
    }

    function updateDashboard() {
        const level = Math.floor(vaultData.totalXP / 100) + 1;
        document.getElementById('header-level').innerText = `LVL ${level}`;
        document.getElementById('goal-title').innerText = vaultData.goalName;
        document.getElementById('stat-points').innerText = `${vaultData.points} / ${vaultData.goalPoints}`;
        document.getElementById('stat-xp').innerText = `${vaultData.totalXP} Lifetime XP`;
        
        let percentage = (vaultData.points / Math.max(vaultData.goalPoints, 1)) * 100;
        if(percentage > 100) percentage = 100;
        document.getElementById('progress-bar').style.width = percentage + "%";
        document.getElementById('progress-bar').style.background = (percentage >= 100 && vaultData.points > 0) ? 'var(--green)' : 'var(--blue)';
    }

    function renderTasks() {
        const missingContainer = document.getElementById('missing-container');
        const assignedContainer = document.getElementById('assigned-container');
        const completedContainer = document.getElementById('completed-container');
        
        missingContainer.innerHTML = ""; assignedContainer.innerHTML = ""; completedContainer.innerHTML = "";
        let hasMissing = false; let hasAssigned = false;
        const todayStr = new Date().toLocaleDateString('en-CA');

        vaultData.tasks.sort((a, b) => new Date(a.due) - new Date(b.due)).forEach(task => {
            const card = document.createElement('div');
            
            if (task.status === 'completed') {
                card.className = "task-card completed";
                card.innerHTML = `
                    <p style="font-weight: 600; font-size: 12px;">${task.subject} <span class="badge" style="background: var(--green)">DONE</span></p>
                    <h3 style="margin: 5px 0;">${task.name}</h3>
                    ${task.notes ? `<p style="margin-top: 5px;"><i>${task.notes}</i></p>` : ''}
                `;
                completedContainer.appendChild(card);
            } else {
                const isMissing = task.due < todayStr;
                card.className = `task-card ${isMissing ? 'missing' : 'active'}`;
                if (isMissing) hasMissing = true; else hasAssigned = true;

                card.innerHTML = `
                    <p style="font-weight: 600; font-size: 12px; color: ${isMissing ? 'var(--red)' : 'var(--text-sub)'};">${task.subject} ‚Ä¢ Due: ${task.due} 
                    <span class="badge" style="background: ${isMissing ? 'var(--red)' : 'var(--blue)'}">${isMissing ? 'LATE' : 'UPCOMING'}</span></p>
                    <h3 style="margin: 5px 0;">${task.name}</h3>
                    ${task.notes ? `<p style="margin-top: 5px; background: var(--app-bg); padding: 10px; border-radius: 8px;">${task.notes}</p>` : ''}
                    
                    <div class="btn-row">
                        <button class="btn-success" style="flex: 2;" onclick="completeTask(${task.id})">‚úÖ Complete (+15 PTS)</button>
                        <button class="btn-danger" style="flex: 1;" onclick="deleteTask(${task.id})">üóëÔ∏è Drop</button>
                    </div>
                `;
                
                if (isMissing) missingContainer.appendChild(card);
                else assignedContainer.appendChild(card);
            }
        });

        document.getElementById('missing-header').style.display = hasMissing ? 'block' : 'none';
        document.getElementById('assigned-header').style.display = hasAssigned ? 'block' : 'none';
        
        if (!hasMissing && !hasAssigned) assignedContainer.innerHTML = `<p style="text-align:center; padding: 20px;">All caught up! Add a mission above.</p>`;
        if (completedContainer.innerHTML === "") completedContainer.innerHTML = `<p style="text-align:center; padding: 20px;">Finished tasks appear here.</p>`;
    }

    // --- DATA ACTIONS ---
    window.addTask = async () => {
        const name = document.getElementById('task-name').value;
        const notes = document.getElementById('task-notes').value;
        const sub = document.getElementById('task-subject').value;
        const due = document.getElementById('task-date').value;
        if(!name || !due) return alert("Assignment name and due date are required!");
        
        const newTask = { id: Date.now(), name, notes, subject: sub, due, status: 'active' };
        await updateDoc(doc(db, "vaults", currentUserUID), { tasks: arrayUnion(newTask) });
        
        document.getElementById('task-name').value = "";
        document.getElementById('task-notes').value = "";
    };

    window.updateGoal = async () => {
        const name = document.getElementById('goal-input-name').value;
        const points = document.getElementById('goal-input-val').value;
        if(!name || !points) return;
        await updateDoc(doc(db, "vaults", currentUserUID), { goalName: name, goalPoints: parseInt(points) });
        document.getElementById('goal-input-name').value = ""; document.getElementById('goal-input-val').value = "";
    };

    window.spendPoints = async () => {
        const cost = prompt("How many points did you spend on your reward?");
        if(cost && !isNaN(cost)) {
            let newTotal = vaultData.points - parseInt(cost);
            if(newTotal < 0) newTotal = 0;
            await updateDoc(doc(db, "vaults", currentUserUID), { points: newTotal });
            alert(`Enjoy your reward! You now have ${newTotal} points left towards your next goal.`);
        }
    };

    window.completeTask = async (taskId) => {
        const updatedTasks = vaultData.tasks.map(t => t.id === taskId ? {...t, status: 'completed'} : t);
        confetti({ particleCount: 150, spread: 80, origin: { y: 0.6 } });
        
        await updateDoc(doc(db, "vaults", currentUserUID), { 
            tasks: updatedTasks,
            points: vaultData.points + 15,
            totalXP: vaultData.totalXP + 15
        });
    };

    window.deleteTask = async (taskId) => {
        if(confirm("Are you sure you want to delete this assignment without getting points?")) {
            const updatedTasks = vaultData.tasks.filter(t => t.id !== taskId);
            await updateDoc(doc(db, "vaults", currentUserUID), { tasks: updatedTasks });
        }
    };

    window.logOut = () => signOut(auth).then(() => location.reload());
</script>
</body>
</html>
