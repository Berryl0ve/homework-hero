<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homework Hero: Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root { --primary: #6366f1; --parent: #f43f5e; --bg: #0f172a; --card: #1e293b; --text: #f8fafc; }
        body { font-family: 'Inter', sans-serif; background: var(--bg); color: var(--text); margin: 0; padding: 15px; }
        .container { max-width: 480px; margin: 0 auto; }
        .hidden { display: none !important; }
        .card { background: var(--card); padding: 20px; border-radius: 24px; border: 1px solid #334155; margin-bottom: 15px; }
        input, select { width: 100%; padding: 14px; margin: 8px 0; background: #0f172a; border: 1px solid #475569; border-radius: 12px; color: white; box-sizing: border-box; }
        button { width: 100%; padding: 16px; border-radius: 12px; border: none; font-weight: bold; cursor: pointer; transition: 0.2s; margin-top: 10px; }
        .btn-stu { background: var(--primary); color: white; }
        .btn-par { background: var(--parent); color: white; }
        .task { background: #334155; padding: 15px; border-radius: 18px; margin: 12px 0; border-left: 6px solid var(--primary); }
        .task.pending { border-left-color: #eab308; }
        .task.rejected { border-left-color: #ef4444; }
        .progress-bg { background: #0f172a; height: 12px; border-radius: 6px; overflow: hidden; margin: 10px 0; border: 1px solid #334155; }
        .progress-fill { background: linear-gradient(90deg, #6366f1, #a855f7); height: 100%; transition: 1s; width: 0%; }
        .badge { font-size: 10px; padding: 4px 8px; border-radius: 6px; text-transform: uppercase; float: right; color: white; }
    </style>
</head>
<body>

<div class="container">
    <h1 style="text-align:center; letter-spacing: -1px;">HERO <span style="color:var(--primary)">PRO</span></h1>

    <div id="view-auth" class="card">
        <h2 style="margin-top:0;">Vault Login</h2>
        <input type="text" id="user-name" placeholder="Unique Username">
        <input type="password" id="user-pin" placeholder="PIN (Student: 4, Parent: 6)">
        <button class="btn-stu" onclick="handleAuth()">Access Vault</button>
        <p id="auth-status" style="font-size: 12px; color: #ef4444; text-align: center;"></p>
    </div>

    <div id="view-main" class="hidden">
        <div class="card">
            <div style="display:flex; justify-content:space-between; align-items:center;">
                <h3 id="welcome-msg" style="margin:0;">Loading...</h3>
                <button onclick="logout()" style="width:auto; padding:8px 12px; margin:0; background:#334155; font-size:11px;">Logout</button>
            </div>
            
            <div id="goal-ui" style="margin-top:15px;">
                <div style="display:flex; justify-content:space-between; font-size:14px;">
                    <span id="goal-text">No Goal</span>
                    <span id="stat-points" style="color:#eab308; font-weight:bold;">0 PTS</span>
                </div>
                <div class="progress-bg"><div id="progress-bar" class="progress-fill"></div></div>
            </div>
        </div>

        <div id="stu-tools" class="hidden">
            <div class="card">
                <h4 style="margin:0 0 10px 0;">Assign Mission</h4>
                <input type="text" id="task-title" placeholder="Homework Description">
                <div style="display:flex; gap:10px;">
                    <select id="task-class">
                        <option>Math</option><option>English</option><option>Science</option><option>History</option><option>Art</option>
                    </select>
                    <input type="date" id="task-date">
                </div>
                <button class="btn-stu" onclick="createTask()">Create Mission</button>
            </div>
            
            <div class="card">
                <h4 style="margin:0 0 10px 0;">Set Point Goal</h4>
                <input type="text" id="goal-name" placeholder="E.g. New Game">
                <input type="number" id="goal-val" placeholder="Points Required">
                <button class="btn-stu" style="background:#475569" onclick="setGoal()">Update Goal</button>
            </div>
        </div>

        <div id="par-tools" class="hidden">
            <div class="card" style="border-color: var(--parent);">
                <h4 style="margin:0 0 10px 0; color:var(--parent);">Parent Toolbox</h4>
                <button class="btn-par" onclick="resetPoints()">Clear All Points</button>
                <p style="font-size:11px; color:#94a3b8; margin-top:10px;">To approve missions, scroll down to the mission list.</p>
            </div>
        </div>

        <h3 style="margin-left:10px;">Missions</h3>
        <div id="mission-list"></div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, updateDoc, arrayUnion, onSnapshot } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-firestore.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.8.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyD0HePOf2DBOPzp5XPjkXjxYWuhs7-WQdQ",
        authDomain: "homeworkhero-f2a15.firebaseapp.com",
        projectId: "homeworkhero-f2a15",
        storageBucket: "homeworkhero-f2a15.firebasestorage.app",
        messagingSenderId: "885878491270",
        appId: "1:885878491270:web:ea7a5e1c1ce178fd1ea907"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let vData = null;
    let uData = null;

    window.handleAuth = async () => {
        const user = document.getElementById('user-name').value.toLowerCase().trim();
        const pin = document.getElementById('user-pin').value;
        if(user.length < 3 || pin.length < 4) return alert("Invalid Login");

        const isPar = pin.length >= 6;
        const email = `${user}${isPar ? '_p' : '_s'}@hero.com`;
        const pass = `pass_${pin}`;

        try {
            await signInWithEmailAndPassword(auth, email, pass);
        } catch (e) {
            try {
                const res = await createUserWithEmailAndPassword(auth, email, pass);
                await setDoc(doc(db, "users", res.user.uid), { name: user, role: isPar ? "Parent" : "Student" });
            } catch (err) { alert("Username taken or PIN wrong!"); }
        }
    };

    auth.onAuthStateChanged(async (u) => {
        if(u) {
            const snap = await getDoc(doc(db, "users", u.uid));
            uData = snap.data();
            initApp();
        } else {
            document.getElementById('view-auth').classList.remove('hidden');
            document.getElementById('view-main').classList.add('hidden');
        }
    });

    function initApp() {
        document.getElementById('view-auth').classList.add('hidden');
        document.getElementById('view-main').classList.remove('hidden');
        document.getElementById('welcome-msg').innerText = `${uData.name} (${uData.role})`;
        
        const isP = uData.role === "Parent";
        document.getElementById('stu-tools').classList.toggle('hidden', isP);
        document.getElementById('par-tools').classList.toggle('hidden', !isP);

        onSnapshot(doc(db, "vaults", uData.name), async (s) => {
            if(!s.exists()) await setDoc(doc(db, "vaults", uData.name), { points: 0, tasks: [], goal: "New Goal", goalPoints: 100 });
            vData = s.data();
            renderUI(isP);
        });
    }

    function renderUI(isP) {
        document.getElementById('stat-points').innerText = vData.points + " PTS";
        document.getElementById('goal-text').innerText = "Target: " + vData.goal;
        const perc = Math.min((vData.points / vData.goalPoints) * 100, 100);
        document.getElementById('progress-bar').style.width = perc + "%";

        const list = document.getElementById('mission-list');
        list.innerHTML = "";
        vData.tasks.forEach(t => {
            const card = document.createElement('div');
            card.className = `task ${t.status}`;
            const bCol = t.status === 'pending' ? '#eab308' : (t.status === 'rejected' ? '#ef4444' : '#6366f1');
            card.innerHTML = `
                <span class="badge" style="background:${bCol}">${t.status}</span>
                <div style="font-size:11px; color:#94a3b8;">${t.subject} â€¢ Due ${t.due}</div>
                <div style="font-weight:bold; font-size:18px; margin:5px 0;">${t.name}</div>
                ${t.img ? `<img src="${t.img}" style="width:100%; border-radius:12px; margin-top:10px;">` : ''}
                ${t.status === 'assigned' && !isP ? `<input type="file" onchange="upload(${t.id}, this)" style="margin-top:10px; font-size:12px;">` : ''}
                ${isP && t.status === 'pending' ? `
                    <div style="display:flex; gap:10px; margin-top:15px;">
                        <button class="btn-stu" style="background:#10b981; padding:10px;" onclick="judge(${t.id}, true)">Approve</button>
                        <button class="btn-stu" style="background:#ef4444; padding:10px;" onclick="judge(${t.id}, false)">Reject</button>
                    </div>
                ` : ''}
            `;
            list.appendChild(card);
        });
    }

    window.createTask = async () => {
        const name = document.getElementById('task-title').value;
        const subject = document.getElementById('task-class').value;
        const due = document.getElementById('task-date').value;
        if(!name || !due) return alert("Fill all fields!");
        await updateDoc(doc(db, "vaults", uData.name), {
            tasks: arrayUnion({ id: Date.now(), name, subject, due, status: 'assigned', img: '' })
        });
        document.getElementById('task-title').value = "";
    };

    window.upload = async (tid, el) => {
        const reader = new FileReader();
        reader.onload = async (e) => {
            const updated = vData.tasks.map(t => t.id === tid ? {...t, status: 'pending', img: e.target.result} : t);
            await updateDoc(doc(db, "vaults", uData.name), { tasks: updated });
        };
        reader.readAsDataURL(el.files[0]);
    };

    window.judge = async (tid, ok) => {
        let newList;
        let pAdd = 0;
        if(ok) {
            newList = vData.tasks.filter(t => t.id !== tid);
            pAdd = 15;
            confetti({ particleCount: 150 });
        } else {
            const why = prompt("Why?");
            newList = vData.tasks.map(t => t.id === tid ? {...t, status: 'rejected', name: t.name + " (Fix: "+why+")", img: ''} : t);
        }
        await updateDoc(doc(db, "vaults", uData.name), { tasks: newList, points: vData.points + pAdd });
    };

    window.setGoal = async () => {
        const goal = document.getElementById('goal-name').value;
        const val = document.getElementById('goal-val').value;
        if(!goal || !val) return;
        await updateDoc(doc(db, "vaults", uData.name), { goal, goalPoints: parseInt(val) });
    };

    window.logout = () => signOut(auth).then(() => location.reload());
    window.resetPoints = async () => confirm("Reset?") && await updateDoc(doc(db, "vaults", uData.name), { points: 0 });
</script>
</body>
</html>
